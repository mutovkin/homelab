# Vector Configuration for VictoriaLogs
# High-performance log collection and routing

# Data directory for buffers
data_dir: "/var/lib/vector"

# Sources - Where logs come from
sources:
  # Docker container logs
  docker_logs:
    type: docker_logs
    docker_host: "unix:///var/run/docker.sock"
    # No include/exclude filters - collect all containers by default
    # This ensures you don't miss logs when adding new services
    # include:  # New: Focus on your stack; adjust as needed
    #   - "homeassistant"
    #   - "grafana"
    #   - "telegraf"
    #   - "vector"  # Include self for debugging, or exclude
    # exclude:  # Updated: Explicit self-exclude if preferred
    #   - "vector"  # But include above for meta-logs

  # Host system logs
  host_logs:
    type: file
    include:
      - /var/log/syslog
      - /var/log/auth.log
      - /var/log/kern.log
    ignore_older_secs: 600  # Ignore logs older than 10 minutes (prevents backfill on restart)
    read_from: end          # Start from end of file (don't replay old logs on startup)

# Transforms - Process and enrich logs
transforms:
  # Parse Docker logs and add metadata
  parse_docker:
    type: remap
    inputs:
      - docker_logs
    source: |
      # Add standard fields for filtering/grouping
      .source = "docker"
      .hostname = get_hostname!()
      
      # Extract container name from Docker metadata
      .container_name = string!(.container_name)
      
      # Set default log level
      .level = "info"
  
  # Parse host system logs
  parse_host:
    type: remap
    inputs:
      - host_logs
    source: |
      .source = "host"
      .hostname = get_hostname!()
      .level = "info"  # System logs don't have explicit levels
  
  # Add timestamp in VictoriaLogs format
  add_timestamp:
    type: remap
    inputs:
      - parse_docker
      - parse_host
    source: |
      # Use current time as timestamp (VictoriaLogs accepts RFC3339 format)
      .timestamp = format_timestamp!(now(), format: "%+")
      
      # Map message field to _msg for VictoriaLogs
      # VictoriaLogs requires _msg field: https://docs.victoriametrics.com/victorialogs/keyconcepts/#message-field
      if exists(.message) {
        ._msg = del(.message)
      }

# Sinks - Where logs go
sinks:
  # Send to VictoriaLogs
  victorialogs:
    type: loki
    inputs:
      - add_timestamp
    endpoint: http://victorialogs:9428/insert
    auth:
      strategy: basic
      user: "${VL_AUTH_USERNAME}"
      password: "${VL_AUTH_PASSWORD}"
    encoding:
      codec: json
    labels:
      container_name: "{{ container_name }}"
      source: "{{ source }}"
      hostname: "{{ hostname }}"
    compression: gzip
    out_of_order_action: accept
    batch:
      max_bytes: 1048576      # 1MB batches (good balance)
      timeout_secs: 5         # Flush every 5 seconds
    buffer:
      type: disk
      max_size: 268435488     # 256MB disk buffer
      when_full: block
    
  # Debug output (optional - comment out in production)
  # Uncomment for troubleshooting Vector processing
  # console:
  #   type: console
  #   inputs:
  #     - add_timestamp
  #   encoding:
  #     codec: json
